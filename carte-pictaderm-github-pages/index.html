<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte Pictaderm — Dermoscopie / Médicale</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root { --pad: 18px; }
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .controls{
      position:absolute;left:var(--pad);top:var(--pad);z-index:1000;
      background:rgba(255,255,255,.96);backdrop-filter:saturate(140%) blur(6px);
      border-radius:16px;padding:14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.12);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:14px;max-width:680px
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #e8e8e8;background:#fff}
    input[type="search"]{border:1px solid #e3e3e3;border-radius:10px;padding:8px 12px;min-width:280px;flex:1}
    button{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;background:#f2f2f2}
    .meta{font-size:12px;color:#666;margin-top:8px}
    @media (max-width:640px){ .controls{left:10px;top:10px;padding:10px 12px} input[type="search"]{min-width:200px} }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <div class="row">
      <label style="flex:1">Rechercher: <input id="q" type="search" placeholder="Nom, ville, code postal…"></label>
      <button id="clear">Effacer</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span>Afficher :</span>
      <label class="chip"><input type="checkbox" id="f-dermo" checked> Dermoscopie</label>
      <label class="chip"><input type="checkbox" id="f-med" checked> Médicale</label>
    </div>
    <div class="meta">Données: <code>pharmacies.csv</code> + <code>dermo.csv</code> • <span id="count">0</span> point(s)</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Map base (France)
    const map = L.map('map', { zoomSnap:.5, zoomDelta:.5 }).setView([46.6, 2.3], 5.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
    const clusters = { dermo: L.markerClusterGroup({ maxClusterRadius:50 }), med: L.markerClusterGroup({ maxClusterRadius:60 }) };
    map.addLayer(clusters.dermo); map.addLayer(clusters.med);

    // Helpers
    function nfd(x){ return String(x||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
    const STOP = new Set(['grande','pharmacie','phie','du','de','des','la','le','les','l','d']);
    function tidyName(s){ let t=nfd(s).replace(/[^a-z0-9]+/g,' ').trim(); t=t.split(' ').filter(w=>w && !STOP.has(w)).join(' '); return t; }
    function buildKey(name, cp){ return tidyName(name)+'|'+(nfd(cp||'')); }
    function keysMap(obj){ const m={}; for(const k in obj){ m[nfd(k)] = k; } return m; }
    function num(v){ if(v==null) return NaN; return parseFloat(String(v).replace(',', '.')); }
    function latK(r){ const k=keysMap(r); return k['latitude']||k['lat']||k['y']; }
    function lngK(r){ const k=keysMap(r); return k['longitude']||k['lng']||k['lon']||k['x']; }
    function popup(r){
      const k=keysMap(r), name=k['name']||k['nom']||k['title']||k['pharmacie'];
      const addr=k['adresse']||k['address']||k['adresse_complete'];
      const city=k['ville']||k['city']; const cp=k['code_postal']||k['cp']||k['postalcode'];
      const phone=k['phone']||k['telephone']||k['téléphone']; const email=k['email'];
      function esc(x){return String(x??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;')}
      function escA(x){return esc(x).replaceAll('"','&quot;')}
      let h=''; if(name) h+=`<strong>${esc(r[name])}</strong><br/>`; if(addr) h+=`${esc(r[addr])}<br/>`;
      if(city||cp){h+=`${cp?esc(r[cp])+' ':''}${city?esc(r[city]):''}<br/>`} if(phone) h+=`☎️ ${esc(r[phone])}<br/>`; if(email) h+=`✉️ <a href="mailto:${escA(r[email])}">${esc(r[email])}</a>`;
      return h||'<em>Pharmacie</em>';
    }

    async function loadCSV(url){ return new Promise((res,rej)=>Papa.parse(url,{download:true,header:true,skipEmptyLines:true,complete:r=>res(r.data||[]),error:rej})); }

    (async function(){
      try{
        const [main, dermo] = await Promise.all([loadCSV('pharmacies.csv'), loadCSV('dermo.csv')]);
        const dermoSet = new Set();
        const dermoByName = new Map();
        dermo.forEach(d=>{
          const kd=keysMap(d); const name=d[kd['name']]; const cp=d[kd['code_postal']];
          if(!name) return; dermoSet.add(buildKey(name, cp));
          const tn=tidyName(name); if(!dermoByName.has(tn)) dermoByName.set(tn, []); dermoByName.get(tn).push({cp:String(cp||'')});
        });

        function isDermo(r){
          const k=keysMap(r); const name=r[k['name']]||r[k['nom']]||r[k['title']]||r[k['pharmacie']];
          if(!name) return false;
          const cp=r[k['code_postal']]||r[k['cp']]||r[k['postalcode']];
          const key=buildKey(name, cp);
          if(dermoSet.has(key)) return true;
          const tn=tidyName(name); const list=dermoByName.get(tn)||[];
          return list.length===1; // name-only unique fallback
        }

        function render(){
          clusters.dermo.clearLayers(); clusters.med.clearLayers();
          const q=nfd(document.getElementById('q').value||''); const showD=document.getElementById('f-dermo').checked; const showM=document.getElementById('f-med').checked;
          const bounds=[]; let n=0;
          main.forEach(r=>{
            if(q){ const hay=nfd(Object.values(r).join(' ')); if(!hay.includes(q)) return; }
            const la=num(r[latK(r)]), lo=num(r[lngK(r)]); if(!Number.isFinite(la)||!Number.isFinite(lo)) return;
            const dermo=isDermo(r); const layer=dermo?clusters.dermo:clusters.med; if((dermo&&!showD)||(!dermo&&!showM)) return;
            const m=L.marker([la,lo]).bindPopup(popup(r)); layer.addLayer(m); bounds.push([la,lo]); n++;
          });
          document.getElementById('count').textContent=n;
          if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
        }

        render();
        document.getElementById('q').addEventListener('input', render);
        document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('q').value=''; render(); });
        document.getElementById('f-dermo').addEventListener('change', render);
        document.getElementById('f-med').addEventListener('change', render);
      }catch(e){ alert('Erreur de chargement: '+e); }
    })();
  </script>
</body>
</html>
